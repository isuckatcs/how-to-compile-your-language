// RUN: compiler %s -llvm-dump 2>&1 | filecheck %s
// RUN: compiler %s -o generic_struct_different_field_offsets && ./generic_struct_different_field_offsets | grep -Plzx '1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n'
struct Empty {}

struct S<T, U, V> {
  x: T,
  y: U,
  z: V,
  n: number
}

fn main() {
  let s = S{ x: Empty{}, y: Empty{}, z: unit, n: 1 };
  // CHECK: %0 = getelementptr inbounds nuw { double }, ptr %S.tmp, i32 0, i32 0
  // CHECK-NEXT: store double 1.000000e+00, ptr %0, align 8
  // CHECK-NEXT: call void @llvm.memcpy.p0.p0.i64(ptr align 8 %s, ptr align 8 %S.tmp, i64 8, i1 false)

  let x = s.x;
  let y = s.y;
  let z = s.z;
  let n = s.n;
  // CHECK-NEXT: %1 = getelementptr inbounds nuw { double }, ptr %s, i32 0, i32 0
  // CHECK-NEXT: %2 = load double, ptr %1, align 8
  // CHECK-NEXT: store double %2, ptr %n, align 8

  println(n);
  // CHECK-NEXT: %3 = load double, ptr %n, align 8
  // CHECK-NEXT: call void @println(double %3)

  let s2 = S{ x: unit, y: Empty{}, z: 2, n: 3 };
  // CHECK-NEXT: %4 = getelementptr inbounds nuw { double, double }, ptr %S.tmp1, i32 0, i32 0
  // CHECK-NEXT: store double 2.000000e+00, ptr %4, align 8
  // CHECK-NEXT: %5 = getelementptr inbounds nuw { double, double }, ptr %S.tmp1, i32 0, i32 1
  // CHECK-NEXT: store double 3.000000e+00, ptr %5, align 8
  // CHECK-NEXT: call void @llvm.memcpy.p0.p0.i64(ptr align 8 %s2, ptr align 8 %S.tmp1, i64 16, i1 false)

  let x2 = s2.x;
  let y2 = s2.y;
  let z2 = s2.z;
  // CHECK-NEXT: %6 = getelementptr inbounds nuw { double, double }, ptr %s2, i32 0, i32 0
  // CHECK-NEXT: %7 = load double, ptr %6, align 8
  // CHECK-NEXT: store double %7, ptr %z2, align 8
  
  let n2 = s2.n;
  // CHECK-NEXT: %8 = getelementptr inbounds nuw { double, double }, ptr %s2, i32 0, i32 1
  // CHECK-NEXT: %9 = load double, ptr %8, align 8
  // CHECK-NEXT: store double %9, ptr %n2, align 8

  println(z2);
  // CHECK-NEXT: %10 = load double, ptr %z2, align 8
  // CHECK-NEXT: call void @println(double %10)

  println(n2);
  // CHECK-NEXT: %11 = load double, ptr %n2, align 8
  // CHECK-NEXT: call void @println(double %11)

  let s3 = S{ x: unit, y: 4, z: 5, n: 6 };
  // CHECK-NEXT: %12 = getelementptr inbounds nuw { double, double, double }, ptr %S.tmp2, i32 0, i32 0
  // CHECK-NEXT: store double 4.000000e+00, ptr %12, align 8
  // CHECK-NEXT: %13 = getelementptr inbounds nuw { double, double, double }, ptr %S.tmp2, i32 0, i32 1
  // CHECK-NEXT: store double 5.000000e+00, ptr %13, align 8
  // CHECK-NEXT: %14 = getelementptr inbounds nuw { double, double, double }, ptr %S.tmp2, i32 0, i32 2
  // CHECK-NEXT: store double 6.000000e+00, ptr %14, align 8
  // CHECK-NEXT: call void @llvm.memcpy.p0.p0.i64(ptr align 8 %s3, ptr align 8 %S.tmp2, i64 24, i1 false)

  let x3 = s3.x;
  let y3 = s3.y;
  // CHECK-NEXT: %15 = getelementptr inbounds nuw { double, double, double }, ptr %s3, i32 0, i32 0
  // CHECK-NEXT: %16 = load double, ptr %15, align 8
  // CHECK-NEXT: store double %16, ptr %y3, align 8

  let z3 = s3.z;
  // CHECK-NEXT: %17 = getelementptr inbounds nuw { double, double, double }, ptr %s3, i32 0, i32 1
  // CHECK-NEXT: %18 = load double, ptr %17, align 8
  // CHECK-NEXT: store double %18, ptr %z3, align 8

  let n3 = s3.n;
  // CHECK-NEXT: %19 = getelementptr inbounds nuw { double, double, double }, ptr %s3, i32 0, i32 2
  // CHECK-NEXT: %20 = load double, ptr %19, align 8
  // CHECK-NEXT: store double %20, ptr %n3, align 8

  println(y3);
  // CHECK-NEXT: %21 = load double, ptr %y3, align 8
  // CHECK-NEXT: call void @println(double %21)

  println(z3);
  // CHECK-NEXT: %22 = load double, ptr %z3, align 8
  // CHECK-NEXT: call void @println(double %22)

  println(n3);
  // CHECK-NEXT: %23 = load double, ptr %n3, align 8
  // CHECK-NEXT: call void @println(double %23)

  let s4 = S{ x: 7, y: 8, z: 9, n: 10 };
  // CHECK-NEXT: %24 = getelementptr inbounds nuw { double, double, double, double }, ptr %S.tmp3, i32 0, i32 0
  // CHECK-NEXT: store double 7.000000e+00, ptr %24, align 8
  // CHECK-NEXT: %25 = getelementptr inbounds nuw { double, double, double, double }, ptr %S.tmp3, i32 0, i32 1
  // CHECK-NEXT: store double 8.000000e+00, ptr %25, align 8
  // CHECK-NEXT: %26 = getelementptr inbounds nuw { double, double, double, double }, ptr %S.tmp3, i32 0, i32 2
  // CHECK-NEXT: store double 9.000000e+00, ptr %26, align 8
  // CHECK-NEXT: %27 = getelementptr inbounds nuw { double, double, double, double }, ptr %S.tmp3, i32 0, i32 3
  // CHECK-NEXT: store double 1.000000e+01, ptr %27, align 8
  // CHECK-NEXT: call void @llvm.memcpy.p0.p0.i64(ptr align 8 %s4, ptr align 8 %S.tmp3, i64 32, i1 false)

  let x4 = s4.x;
  // CHECK-NEXT: %28 = getelementptr inbounds nuw { double, double, double, double }, ptr %s4, i32 0, i32 0
  // CHECK-NEXT: %29 = load double, ptr %28, align 8
  // CHECK-NEXT: store double %29, ptr %x4, align 8

  let y4 = s4.y;
  // CHECK-NEXT: %30 = getelementptr inbounds nuw { double, double, double, double }, ptr %s4, i32 0, i32 1
  // CHECK-NEXT: %31 = load double, ptr %30, align 8
  // CHECK-NEXT: store double %31, ptr %y4, align 8

  let z4 = s4.z;
  // CHECK-NEXT: %32 = getelementptr inbounds nuw { double, double, double, double }, ptr %s4, i32 0, i32 2
  // CHECK-NEXT: %33 = load double, ptr %32, align 8
  // CHECK-NEXT: store double %33, ptr %z4, align 8

  let n4 = s4.n;
  // CHECK-NEXT: %34 = getelementptr inbounds nuw { double, double, double, double }, ptr %s4, i32 0, i32 3
  // CHECK-NEXT: %35 = load double, ptr %34, align 8
  // CHECK-NEXT: store double %35, ptr %n4, align 8


  println(x4);
  // CHECK-NEXT: %36 = load double, ptr %x4, align 8
  // CHECK-NEXT: call void @println(double %36)
  // CHECK-NEXT: %37 = load double, ptr %y4, align 8
  
  println(y4);
  // CHECK-NEXT: call void @println(double %37)
  
  println(z4);
  // CHECK-NEXT: %38 = load double, ptr %z4, align 8
  // CHECK-NEXT: call void @println(double %38)
  
  println(n4);
  // CHECK-NEXT: %39 = load double, ptr %n4, align 8
  // CHECK-NEXT: call void @println(double %39)
}
